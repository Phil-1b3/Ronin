# GitHub Webhook Pipeline Setup Guide

## Overview
Your pipeline is now configured to automatically trigger when code is pushed to the main branch of your GitHub repository. Here's what we've set up:

## Configuration Changes Made:

### 1. **CodePipeline Updates** (`Code-Pipeline.tf`)
- ✅ Disabled polling (`PollForSourceChanges = "false"`)
- ✅ Added GitHub webhook resource
- ✅ Added webhook authentication with secret
- ✅ Configured to trigger only on main branch pushes

### 2. **Provider Configuration** (`provider.tf`)
- ✅ Added GitHub provider
- ✅ Configured with your GitHub token

### 3. **Variables** (`terraform.tfvars`)
- ✅ GitHub token configured
- ✅ Webhook secret generated: `IMRqjyXsdulAPnoLfOSgDb8GtFJ5wZxU`

## How It Works:

```
GitHub Push → Webhook → CodePipeline → CodeBuild → ECR → ECS
```

1. **Push to main branch** → Triggers webhook
2. **CodePipeline starts** → Downloads source code
3. **CodeBuild runs** → Builds Docker image using `pract/buildspec.yml`
4. **Image pushed to ECR** → Stores Docker image
5. **ECS deployment** → Updates running service

## Next Steps:

### 1. **Deploy the Infrastructure**
```bash
cd Terraform
terraform init
terraform plan
terraform apply
```

### 2. **Verify GitHub Token Permissions**
Make sure your GitHub token has these permissions:
- ✅ `repo` (Full control of private repositories)
- ✅ `admin:repo_hook` (Full control of repository hooks)

### 3. **Test the Webhook**
After deployment:
1. Make a change to any file in your repository
2. Commit and push to the main branch
3. Check AWS CodePipeline console - it should automatically start

### 4. **Monitor the Pipeline**
- **AWS CodePipeline Console**: Monitor pipeline execution
- **AWS CodeBuild Console**: View build logs
- **AWS ECS Console**: Check service updates

## Webhook Details:

- **Trigger**: Push events to `main` branch only
- **Authentication**: HMAC with secret token
- **URL**: Auto-generated by AWS CodePipeline
- **Content-Type**: JSON

## Troubleshooting:

### If webhook doesn't trigger:
1. Check GitHub webhook settings in your repository
2. Verify webhook secret matches
3. Check CodePipeline IAM permissions
4. Review GitHub token permissions

### If build fails:
1. Check CodeBuild logs
2. Verify buildspec.yml syntax
3. Check Docker image pull permissions
4. Verify ECR repository exists

### If deployment fails:
1. Check ECS service configuration
2. Verify task definition
3. Check security groups and networking
4. Review ECS service logs

## Manual Testing Commands:

```bash
# Test AWS credentials
aws sts get-caller-identity --profile phils_profile

# List ECR repositories
aws ecr describe-repositories --profile phils_profile

# Check ECS services
aws ecs list-services --cluster phils-cluster --profile phils_profile

# View pipeline status
aws codepipeline get-pipeline-state --name phils-pipeline --profile phils_profile
```

## Security Notes:

- ✅ Webhook secret is 32 characters long and secure
- ✅ GitHub token is marked as sensitive in Terraform
- ✅ terraform.tfvars is in .gitignore
- ⚠️ Never commit secrets to version control

## What Happens on Next Commit:

1. You push code to main branch
2. GitHub sends webhook to AWS
3. CodePipeline automatically starts
4. Build, test, and deploy happen automatically
5. Your ECS service updates with new Docker image

Ready to deploy! Run `terraform apply` when you're ready to activate the webhook.
